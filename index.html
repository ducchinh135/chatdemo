<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trợ lý du lịch ảo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=ww5IVhWH"></script>
    <style>
      /* CSS cho popup */
      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 1000;
      }
      .popup.show {
        display: block;
      }
      .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
      }
      .popup-overlay.show {
        display: block;
      }

      /* Typing loader animation */
      .typing-container {
        display: flex;
        align-items: center;
        font-style: italic;
        color: #555;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #555;
        border-radius: 50%;
        margin: 0 2px;
        animation: typingDot 1.5s infinite ease-in-out;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typingDot {
        0%,
        100% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <main id="app" class="min-h-screen bg-gray-100 p-8 bg-background relative">
      <!-- Hình ảnh bên trái -->
      <div class="fixed left-0 top-0 h-full w-[10%] sm:w-1/6 md:w-1/5 xl:w-1/4">
        <img
          src="./image/dia-diem-du-lich-bac-ninh-1.jpg"
          alt="Left Image"
          class="w-full h-full object-cover"
        />
      </div>
      <!-- Nội dung chính -->
      <div
        class="max-w-2xl mx-auto relative w-[92%] sm:w-[50%] md:w-[60%] lg:w-[60%] xl:w-[80%]"
      >
        <div class="relative">
          <div class="mb-4 flex items-center justify-center">
            <h1 class="text-3xl font-bold text-center pr-2">Trợ lý du lịch</h1>
            <img
              class="w-14 h-14 rounded-full"
              src="./image/banner_quanho.jpg"
              alt="ChatGPT Icon"
            />
          </div>
          <button
            @click="toggleSettingsPopup"
            class="absolute top-4 right-4 p-2 text-gray-500 hover:text-gray-700"
            aria-label="Cài đặt"
          >
            <i class="fas fa-cog fa-lg"></i>
          </button>
          <div class="bg-white shadow rounded-lg p-1 sm:p-6">
            <div class="flow-root">
              <div class="mt-3 sm:mt-6">
                <!-- Chat Messages -->
                <ul>
                  <li
                    class="py-3 sm:py-4"
                    v-for="message in messages"
                    :key="message.id"
                  >
                    <div
                      class="flex items-start gap-4"
                      :class="messageClasses(message.role)"
                    >
                      <div
                        v-if="message.role === 'user'"
                        class="relative p-2 sm:p-4 bg-gray-100 rounded-lg shadow-md break-normal whitespace-pre-line"
                      >
                        <span v-if="message.role === 'user'" class="font-bold"
                          >Bạn:</span
                        >
                        {{ message.content }}
                      </div>
                      <div
                        v-if="message.role === 'assistant'"
                        class="flex-shrink-0"
                      >
                        <img
                          class="w-8 h-8 rounded-full"
                          src="./image/Biểu_trưng_tỉnh_Bắc_Ninh.svg"
                          alt="ChatGPT Icon"
                        />
                      </div>
                      <div
                        v-if="message.role !== 'user'"
                        class="flex-1 min-w-0"
                      >
                        <p
                          class="text-sm text-gray-800 break-normal whitespace-pre-line"
                        >
                          <span
                            v-if="message.role === 'assistant'"
                            class="font-bold"
                            >Trợ lý:</span
                          >
                          {{ message.content }}
                        </p>
                        <!-- Biểu tượng loa để đọc nội dung -->
                        <button
                          v-if="message.role === 'assistant'"
                          @click="speakMessage(message.content)"
                          class="text-gray-500 hover:text-gray-700 ml-2 text-[10px]"
                          aria-label="Đọc nội dung"
                        >
                          <i class="fas fa-volume-up fa-lg"></i>
                        </button>
                      </div>
                    </div>
                  </li>
                  <!-- Typing Indicator -->
                  <!-- <li v-if="isTyping" class="py-3 sm:py-4">
                    <div
                      class="flex items-center space-x-4 text-left justify-start"
                    >
                      <div class="flex-shrink-0">
                        <img
                          class="w-8 h-8 rounded-full"
                          src="./image/Biểu_trưng_tỉnh_Bắc_Ninh.svg"
                          alt="ChatGPT Icon"
                        />
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="typing-container">
                          <span class="typing-dot"></span>
                          <span class="typing-dot"></span>
                          <span class="typing-dot"></span>
                        </p>
                      </div>
                    </div>
                  </li> -->
                </ul>

                <!-- Chat Input -->
                <form @submit.prevent="sendMessage">
                  <div class="flex space-y-2 sm:space-y-0 sm:space-x-3">
                    <textarea
                      v-model="userInput"
                      placeholder="Điền câu hỏi của bạn..."
                      class="flex-1 rounded-md shadow-sm p-2 w-full h-auto resize-none mr-1"
                      rows="1"
                    ></textarea>
                    <button
                      type="submit"
                      class="px-4 py-2 bg-amber-200 text-black rounded-md hover:bg-amber-300 flex items-center"
                    >
                      <img
                        class="w-4 h-4"
                        src="./image/send-svgrepo-com.svg"
                        alt="Send Icon"
                      />
                      Gửi
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hình ảnh bên phải -->
      <div
        class="fixed right-0 top-0 h-full w-[10%] sm:w-1/6 md:w-1/5 xl:w-1/4"
      >
        <img
          src="./image/netduyentrongquanghobacninh.jpg"
          alt="Right Image"
          class="w-full h-full object-cover"
        />
      </div>

      <!-- Popup cài đặt -->
      <div
        class="popup-overlay"
        :class="{ show: showPopup }"
        @click="closeSettingsPopup"
      ></div>
      <div class="popup w-[50%]" :class="{ show: showPopup }">
        <h2 class="text-xl font-bold mb-4">Cài đặt</h2>
        <textarea
          v-model="settingsText"
          class="w-full h-32 p-2 border border-gray-300 rounded-md"
          placeholder="Nhập văn bản ở đây..."
        ></textarea>
        <div class="mt-4 text-right">
          <button
            @click="saveSettings"
            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
          >
            Xác nhận
          </button>
          <button
            @click="closeSettingsPopup"
            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 ml-2"
          >
            Hủy
          </button>
        </div>
      </div>
    </main>

    <script>
      const { createApp, ref, nextTick } = Vue;

      createApp({
        setup() {
          const userInput = ref("");
          const messages = ref([]);
          const isLoading = ref(false);
          const showPopup = ref(false);
          const settingsText = ref("");
          const isFirstMessage = ref(true); // Biến cờ để theo dõi tin nhắn đầu tiên
          const isTyping = ref(false); // Trạng thái gõ chữ

          const messageClasses = (role) => ({
            "text-right justify-end": role === "user",
            "text-left justify-start": role === "assistant",
          });

          async function sendMessage() {
            if (!userInput.value.trim()) return;

            try {
              // Append user message
              messages.value.push({
                role: "user",
                content: userInput.value,
              });

              const systemMessage = {
                role: "system",
                content: "Bạn là trợ lý Ai tuyệt vời. Hãy trả lời ngắn gọn",
              };

              const allMessages = [
                systemMessage,
                ...messages.value.map((msg) => ({
                  role: msg.role,
                  content: msg.content,
                })),
              ];

              const response = await fetch(
                "http://192.168.137.1:1234/v1/chat/completions",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    model:
                      "uonlp/Vistral-7B-Chat-gguf/ggml-vistral-7B-chat-q4_0.gguf",
                    temperature: 0.7,
                    max_tokens: -1,
                    stream: true, // Bật chế độ streaming
                    messages: allMessages,
                  }),
                }
              );

              userInput.value = "";

              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let result = "";

              // Add an initial message for the assistant
              messages.value.push({
                role: "assistant",
                content: "",
              });

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                result += decoder.decode(value, { stream: true });

                // Process and update the content
                const contentChunks = result
                  .split("\n")
                  .filter((line) => line.trim());
                for (const chunk of contentChunks) {
                  // Tách phần JSON từ chuỗi `data: { ... }`
                  const jsonChunks = chunk
                    .split("data: ")
                    .filter((part) => part.trim());

                  for (const jsonChunk of jsonChunks) {
                    try {
                      const data = JSON.parse(jsonChunk);
                      if (data.choices && data.choices.length > 0) {
                        const content = data.choices[0].delta?.content || "";

                        // Update the last assistant message with the new content
                        const lastMessage =
                          messages.value[messages.value.length - 1];
                        lastMessage.content += content;

                        nextTick(() => {
                          // Cuộn xuống khi có tin nhắn mới
                          const chatBox = document.querySelector(".chat-box");
                          if (chatBox) {
                            chatBox.scrollTop = chatBox.scrollHeight;
                          }
                        });
                      }
                    } catch (error) {
                      console.error("Error parsing JSON chunk", error);
                    }
                  }
                }

                // Clear the result after processing
                result = "";
              }
            } catch (error) {
              console.error("There was an error with the API request", error);
            } finally {
              isLoading.value = false;
              isTyping.value = false; // Kết thúc trạng thái gõ chữ
            }
          }

          function speakMessage(message) {
            if (window.responsiveVoice) {
              responsiveVoice.speak(message, "Vietnamese Female"); // Bạn có thể thay đổi giọng đọc và ngôn ngữ theo nhu cầu
            } else {
              console.error("ResponsiveVoice is not loaded");
            }
          }

          function toggleSettingsPopup() {
            showPopup.value = !showPopup.value;
          }

          function closeSettingsPopup() {
            showPopup.value = false;
          }

          function saveSettings() {
            // Lưu giá trị từ textarea vào biến settingsText
            settingsText.value = settingsText.value.trim();
            console.log("settingsText.value", settingsText.value);
            closeSettingsPopup();
          }

          return {
            userInput,
            messages,
            messageClasses,
            sendMessage,
            isLoading,
            speakMessage,
            toggleSettingsPopup,
            closeSettingsPopup,
            saveSettings,
            showPopup,
            settingsText,
            isTyping,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
